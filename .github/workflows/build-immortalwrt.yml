# å®šä¹‰å·¥ä½œæµçš„åç§°
name: build-immortalwrt

# è‡ªå®šä¹‰å·¥ä½œæµè¿è¡Œçš„æ˜¾ç¤ºåç§°ï¼Œæ¨¡æ¿å˜é‡ ${{ github.actor }} ä¼šåŠ¨æ€æ›¿æ¢ä¸ºè§¦å‘å·¥ä½œæµçš„ GitHub ç”¨æˆ·å
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€
# å®šä¹‰å·¥ä½œæµè§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
on:
  workflow_dispatch:
    # è¾“å…¥å‚æ•°
    inputs:
      platform_type:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘å›ºä»¶å¯¹åº”å¹³å°'
        required: false
        default: 'x86-64'
        type: choice
        options:
          - 'x86-64'
          - 'Raspberry-Pi-4B'
      firmware_version:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘å›ºä»¶ç‰ˆæœ¬'
        required: false
        default: '24.10.0'
        type: choice
        options:
          - '24.10.0'
          - '23.05.4'
      firmware_size:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘å›ºä»¶å¤§å°ï¼ˆæ”¯æŒé€—å·åˆ†éš”å¤šç§å¤§å°åŒæ—¶ç¼–è¯‘ï¼‰å•ä½(MB)'
        required: true
        default: '4096'
      include_docker:
        description: |
          æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'


# è¿™å®šä¹‰äº†ä¸€ä¸ªåä¸ºbuildçš„ä½œä¸šï¼ˆå·¥ä½œæµï¼‰
jobs:
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºUbuntu 22.04
    runs-on: ubuntu-22.04

    # è®¾ç½®ç¯å¢ƒå˜é‡
    env:
      sys_pwd: ${{ secrets.SYS_PWD }}
      lan_ip: ${{ secrets.LAN_IP }}
      wifi_name: ${{ secrets.WIFI_NAME }}
      wifi_pwd: ${{ secrets.WIFI_PWD }}
      platform_type: "${{ github.event.inputs.platform_type }}"
      firmware_version: "${{ github.event.inputs.firmware_version }}"
      firmware_sizes: "${{ github.event.inputs.firmware_size }}"
      include_docker: "${{ github.event.inputs.include_docker }}"

    # å®šä¹‰ä½œä¸šï¼ˆå·¥ä½œæµï¼‰æ­¥éª¤
    steps:
      - name: æ‰“å°ç¯å¢ƒå˜é‡        
        run: |
          echo "å›ºä»¶ç‰ˆæœ¬:${{ github.event.inputs.firmware_version }}"
          echo "å›ºä»¶å¤§å°:${{ github.event.inputs.firmware_size }}"
          echo "æ˜¯å¦åŒ…æ‹¬å®¹å™¨æ’ä»¶:${{ github.event.inputs.include_docker }}"
          echo "å›ºä»¶ä¿¡æ¯ version:$firmware_version, size:$firmware_sizes, include_docker:$include_docker"
          echo "ç³»ç»Ÿä¿¡æ¯ sys_pwd:$sys_pwd, lan_ip:$lan_ip, wifi_name:$wifi_name, wifi_pwd:$wifi_pwd"

      - name: 1. æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      # è®¾ç½®æ„å»ºè„šæœ¬çš„æ‰§è¡Œæƒé™
      - name: ç¼–è¯‘å‰ç¯å¢ƒå‡†å¤‡
        run: |
          # è®¾ç½®æ„å»ºè„šæœ¬çš„æ‰§è¡Œæƒé™
          chmod +x ${{ github.workspace }}/x86-64/build.sh     

      - name: 2. æ„å»ºImmortalWrtå›ºä»¶
        run: |
          platform_type="${{ github.event.inputs.platform_type }}"
          firmware_version="${{ github.event.inputs.firmware_version }}"
          firmware_sizes="${{ github.event.inputs.firmware_size }}"
          
          # å®ƒå°† firmware_sizes å­—ç¬¦ä¸²æŒ‰é€—å·åˆ†éš”ï¼Œæ‹†åˆ†æˆæ•°ç»„ firmware_size_list
          IFS=',' read -r -a firmware_size_list <<< "$firmware_sizes"

          # å¾ªç¯æ„å»ºä¸åŒå¤§å°çš„å›ºä»¶
          for firmware_size in "${firmware_size_list[@]}"; do
            echo "å›ºä»¶ä¿¡æ¯ version: $firmware_version, size: $firmware_size, include_docker: $include_docker"

            # è¿è¡ŒDockerå®¹å™¨è¿›è¡Œæ„å»º
            # --rm ï¼šå®¹å™¨åœæ­¢åè‡ªåŠ¨åˆ é™¤ï¼Œé¿å…å ç”¨ç£ç›˜ç©ºé—´
            # -i ï¼šäº¤äº’æ¨¡å¼è¿è¡Œï¼Œä¿æŒæ ‡å‡†è¾“å…¥æ‰“å¼€
            # --user root ï¼šä»¥rootç”¨æˆ·èº«ä»½åœ¨å®¹å™¨å†…è¿è¡Œå‘½ä»¤ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæƒé™
            # -v ï¼šå·æŒ‚è½½
            # -e ï¼šç¯å¢ƒå˜é‡ä¼ é€’
            docker run --rm -i \
              --user root \
              -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
              -v "${{ github.workspace }}/files:/home/build/immortalwrt/files" \
              -v "${{ github.workspace }}/build.sh:/home/build/immortalwrt/build.sh" \
              -e SYS_PWD=${{ secrets.SYS_PWD }} \
              -e LAN_IP=${{ secrets.LAN_IP }} \
              -e WIFI_NAME=${{ secrets.WIFI_NAME }} \
              -e WIFI_PWD=${{ secrets.WIFI_PWD }} \
              -e PART_SIZE=$firmware_size \
              -e ZIP_PWD=${{ secrets.ZIP_PWD }} \
              immortalwrt/imagebuilder:$platform_type-openwrt-$firmware_version /bin/bash /home/build/immortalwrt/build.sh
          done

      - name: ç”Ÿæˆå›ºä»¶SHA-256æ ¡éªŒå’Œ
        run: |
          # æ˜¾ç¤ºbinç›®å½•å†…å®¹ï¼Œç”¨äºè°ƒè¯•
          echo "binç›®å½•å†…å®¹:"
          find ${{ github.workspace }}/bin -name "*.zip" | sort
          
          # å¤åˆ¶åŠ å¯†zipåŒ…åˆ°å·¥ä½œç›®å½•ï¼ˆç›´æ¥ä»binç›®å½•ï¼‰
          cp ${{ github.workspace }}/bin/*.zip ${{ github.workspace }}/ || true
          # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
          cp ${{ github.workspace }}/bin/config_old.txt ${{ github.workspace }}/
          cp ${{ github.workspace }}/bin/config_new.txt ${{ github.workspace }}/
          
          # æ˜¾ç¤ºå½“å‰ç›®å½•å†…å®¹ï¼Œç”¨äºè°ƒè¯•
          echo "å½“å‰å·¥ä½œç›®å½•å†…å®¹:"
          ls -la ${{ github.workspace }}
          
          # ä¸ºæ‰€æœ‰zipåŒ…ç”ŸæˆSHA-256æ ¡éªŒå’Œ
          for file in *.zip; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256"
              sha256sum -c "$file.sha256"
            fi
          done

      # åˆ›å»ºå›ºä»¶ä¿¡æ¯æ–‡ä»¶
      - name: ç”Ÿæˆå›ºä»¶ä¿¡æ¯æ–‡ä»¶
        run: |
          # åˆ›å»ºåŸºæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "### ImmortalWrt å›ºä»¶ä¿¡æ¯" > ${{ github.workspace }}/info.md
          echo "- å¹³å°: ${{ github.event.inputs.platform_type }}" >> ${{ github.workspace }}/info.md
          echo "- ç‰ˆæœ¬: ${{ github.event.inputs.firmware_version }}" >> ${{ github.workspace }}/info.md
          echo "- å›ºä»¶å¤§å°: ${{ github.event.inputs.firmware_size }} MB" >> ${{ github.workspace }}/info.md
          
          # æ·»åŠ Dockerä¿¡æ¯
          if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
            echo "- åŒ…å«Dockeræ’ä»¶: æ˜¯" >> ${{ github.workspace }}/info.md
          else
            echo "- åŒ…å«Dockeræ’ä»¶: å¦" >> ${{ github.workspace }}/info.md
          fi
          
          # æ·»åŠ é…ç½®æ–‡ä»¶ä¿¡æ¯
          if [ -f "${{ github.workspace }}/config_old.txt" ] && [ -f "${{ github.workspace }}/config_new.txt" ]; then
            echo -e "\n### é…ç½®æ–‡ä»¶" >> ${{ github.workspace }}/info.md
            echo "- config_old.txt - åŸå§‹é…ç½®æ–‡ä»¶" >> ${{ github.workspace }}/info.md
            echo "- config_new.txt - ä¿®æ”¹åé…ç½®æ–‡ä»¶" >> ${{ github.workspace }}/info.md
          fi
          
          # æ·»åŠ åŠ å¯†zipåŒ…
          if ls *.zip 1> /dev/null 2>&1; then
            echo -e "\n### åŠ å¯†å›ºä»¶åŒ…" >> ${{ github.workspace }}/info.md
            echo "- åŠ å¯†æ–¹å¼: ZIPåŠ å¯†" >> ${{ github.workspace }}/info.md
            echo "- å¯†ç : è¯·è”ç³»ç®¡ç†å‘˜è·å–" >> ${{ github.workspace }}/info.md
            for file in *.zip; do
              echo "- $file" >> ${{ github.workspace }}/info.md
            done
          fi
          
          # æ·»åŠ SHA256æ ¡éªŒå’Œä¿¡æ¯
          if ls *.zip.sha256 1> /dev/null 2>&1; then
            echo -e "\n### å›ºä»¶SHA256æ ¡éªŒå’Œ" >> ${{ github.workspace }}/info.md
            for file in *.zip; do
              if [ -f "$file.sha256" ]; then
                echo "#### $file" >> ${{ github.workspace }}/info.md
                echo '```' >> ${{ github.workspace }}/info.md
                cat "$file.sha256" >> ${{ github.workspace }}/info.md
                echo '```' >> ${{ github.workspace }}/info.md
              fi
            done
          fi

      # åˆ é™¤å·²å­˜åœ¨çš„æ ‡ç­¾
      - name: åˆ é™¤å·²ç»å­˜åœ¨çš„æ ‡ç­¾
        run: |
          git push --delete origin build-immortalwrt || true
        continue-on-error: true

      # enerate_release_notes: false - ç¦æ­¢è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
      # draft: false - ç›´æ¥å‘å¸ƒè€Œä¸æ˜¯åˆ›å»ºè‰ç¨¿
      # prerelease: false - ä¸æ ‡è®°ä¸ºé¢„å‘å¸ƒ
      # make_latest: true - å°†æ­¤å‘å¸ƒæ ‡è®°ä¸ºæœ€æ–°ç‰ˆæœ¬
      - name: å°†æ„å»ºçš„å›ºä»¶ä½œä¸ºReleaseå‘å¸ƒ
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: build-immortalwrt
          body_path: ${{ github.workspace }}/info.md
          files: |
            ${{ github.workspace }}/*.zip
            ${{ github.workspace }}/*.sha256
            ${{ github.workspace }}/config_old.txt
            ${{ github.workspace }}/config_new.txt
          token: ${{ secrets.GITHUB_TOKEN }}
          generate_release_notes: false
          draft: false
          prerelease: false
          make_latest: true