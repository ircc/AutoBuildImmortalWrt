# å®šä¹‰å·¥ä½œæµçš„åç§°
name: build-immortalwrt

# è‡ªå®šä¹‰å·¥ä½œæµè¿è¡Œçš„æ˜¾ç¤ºåç§°ï¼Œæ¨¡æ¿å˜é‡ ${{ github.actor }} ä¼šåŠ¨æ€æ›¿æ¢ä¸ºè§¦å‘å·¥ä½œæµçš„ GitHub ç”¨æˆ·å
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€
# å®šä¹‰å·¥ä½œæµè§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
on:
  workflow_dispatch:
    # è¾“å…¥å‚æ•°
    inputs:
      platform_type:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘å›ºä»¶å¯¹åº”å¹³å°'
        required: false
        default: 'x86-64'
        type: choice
        options:
          - 'x86-64'
          - 'Raspberry-Pi-4B'
      firmware_version:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘å›ºä»¶ç‰ˆæœ¬'
        required: false
        default: '24.10.0'
        type: choice
        options:
          - '24.10.0'
          - '23.05.4'
      firmware_size:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘å›ºä»¶å¤§å°ï¼ˆæ”¯æŒé€—å·åˆ†éš”å¤šç§å¤§å°åŒæ—¶ç¼–è¯‘ï¼‰å•ä½(MB)'
        required: true
        default: '4096'
      enable_pppoe:
        description: "æ˜¯å¦å¯ç”¨PPPoEæ‹¨å·"
        required: true
        default: 'no'
        type: choice
        options:
        - 'yes'
        - 'no'
      custom_packages:
        description: 'è‡ªå®šä¹‰è½¯ä»¶åŒ…åˆ—è¡¨ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰'
        required: false
        default: ''


# è¿™å®šä¹‰äº†ä¸€ä¸ªåä¸ºbuildçš„ä½œä¸šï¼ˆå·¥ä½œæµï¼‰
jobs:
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºUbuntu 22.04
    runs-on: ubuntu-22.04

    # è®¾ç½®ç¯å¢ƒå˜é‡
    env:
      sys_pwd: ${{ secrets.SYS_PWD }}
      lan_ip: ${{ secrets.LAN_IP }}
      wifi_name: ${{ secrets.WIFI_NAME }}
      wifi_pwd: ${{ secrets.WIFI_PWD }}
      platform_type: "${{ github.event.inputs.platform_type }}"
      firmware_version: "${{ github.event.inputs.firmware_version }}"
      firmware_sizes: "${{ github.event.inputs.firmware_size }}"
      enable_pppoe: "${{ github.event.inputs.enable_pppoe }}"
      custom_packages: "${{ github.event.inputs.custom_packages }}"

    # å®šä¹‰ä½œä¸šï¼ˆå·¥ä½œæµï¼‰æ­¥éª¤
    steps:
      - name: æ‰“å°ç¯å¢ƒå˜é‡        
        run: |
          echo "å›ºä»¶ç‰ˆæœ¬:${{ github.event.inputs.firmware_version }}"
          echo "å›ºä»¶å¤§å°:${{ github.event.inputs.firmware_size }}"
          echo "æ˜¯å¦å¯ç”¨PPPoEæ‹¨å·:${{ github.event.inputs.enable_pppoe }}"
          echo "è‡ªå®šä¹‰è½¯ä»¶åŒ…:${{ github.event.inputs.custom_packages }}"
          echo "å›ºä»¶ä¿¡æ¯ version:$firmware_version, size:$firmware_sizes"

      - name: 1. æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      # è®¾ç½®æ„å»ºè„šæœ¬çš„æ‰§è¡Œæƒé™
      - name: ç¼–è¯‘å‰ç¯å¢ƒå‡†å¤‡
        run: |
          # è®¾ç½®æ„å»ºè„šæœ¬çš„æ‰§è¡Œæƒé™
          chmod +x ${{ github.workspace }}/src/build.sh

          #å‡†å¤‡ç¯å¢ƒå˜é‡æ–‡ä»¶
          platform_type="${{ github.event.inputs.platform_type }}"
          firmware_version="${{ github.event.inputs.firmware_version }}"
          pppoe_enable="${{ github.event.inputs.enable_pppoe }}"
          custom_packages="${{ github.event.inputs.custom_packages }}"

          # æ„å»ºå®Œæ•´çš„é•œåƒåç§°
          # æ ¹æ®å¹³å°ç±»å‹é€‰æ‹©æ­£ç¡®çš„Dockeré•œåƒåç§°
          if [ "$platform_type" = "Raspberry-Pi-4B" ]; then
            # æ ‘è“æ´¾4Bä½¿ç”¨bcm27xx-bcm2711ä½œä¸ºé•œåƒåç§°
            image_name="immortalwrt/imagebuilder:bcm27xx-bcm2711-openwrt-${firmware_version}"
            # æ ‘è“æ´¾4Bç‰¹å®šçš„æ„å»ºé…ç½®
            profile="rpi-4"
            echo "ä½¿ç”¨æ ‘è“æ´¾4Bé…ç½®æ–‡ä»¶: $profile"
          else
            # x86-64ä¿æŒä¸å˜
            image_name="immortalwrt/imagebuilder:${platform_type}-openwrt-${firmware_version}"
            # x86-64é»˜è®¤é…ç½®
            profile="generic"
            echo "ä½¿ç”¨x86-64é…ç½®æ–‡ä»¶: $profile"
          fi
          
          echo "ä½¿ç”¨Dockeré•œåƒ: $image_name"
          # å°†é•œåƒåç§°ä¿å­˜ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "IMAGE_NAME=$image_name" >> $GITHUB_ENV

          # åˆ›å»ºbinç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p "${{ github.workspace }}/bin"
          # åˆ›å»ºsrcç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p "${{ github.workspace }}/src"

          # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
          cat > env.list << EOF
          SYS_ACCOUNT=${{ secrets.SYS_ACCOUNT }}
          SYS_PWD=${{ secrets.SYS_PWD }}
          LAN_IP=${{ secrets.LAN_IP }}
          WIFI_NAME=${{ secrets.WIFI_NAME }}
          WIFI_PWD=${{ secrets.WIFI_PWD }}
          PPPOE_ENABLE="${{ github.event.inputs.enable_pppoe }}"
          PPPOE_ACCOUNT=${{ secrets.PPPOE_ACCOUNT }}
          PPPOE_PWD=${{ secrets.PPPOE_PWD }}
          BUILD_AUTH=${{ secrets.BUILD_AUTH }}
          ZIP_PWD=${{ secrets.ZIP_PWD }}
          PLATFORM_TYPE="${{ github.event.inputs.platform_type }}"
          FIRMWARE_VERSION="${{ github.event.inputs.firmware_version }}"
          BUILD_PROFILE="${profile}"
          CUSTOM_PACKAGES="${{ github.event.inputs.custom_packages }}"
          EOF

          echo "ç¯å¢ƒå˜é‡æ–‡ä»¶åˆ›å»ºæˆåŠŸ"

      - name: 2. æ„å»ºImmortalWrtå›ºä»¶
        run: |
          firmware_sizes="${{ github.event.inputs.firmware_size }}"
          platform_type="${{ github.event.inputs.platform_type }}"
          
          # å®ƒå°† firmware_sizes å­—ç¬¦ä¸²æŒ‰é€—å·åˆ†éš”ï¼Œæ‹†åˆ†æˆæ•°ç»„ firmware_size_list
          IFS=',' read -r -a firmware_size_list <<< "$firmware_sizes"

          # å¾ªç¯æ„å»ºä¸åŒå¤§å°çš„å›ºä»¶
          for firmware_size in "${firmware_size_list[@]}"; do
            echo "å›ºä»¶ä¿¡æ¯ platform: $platform_type, version: ${{ github.event.inputs.firmware_version }}, size: $firmware_size"

            # è¿è¡ŒDockerå®¹å™¨è¿›è¡Œæ„å»º (ä½¿ç”¨ç¯å¢ƒå˜é‡æ–‡ä»¶)
            # --rm ï¼šå®¹å™¨åœæ­¢åè‡ªåŠ¨åˆ é™¤ï¼Œé¿å…å ç”¨ç£ç›˜ç©ºé—´
            # -i ï¼šäº¤äº’æ¨¡å¼è¿è¡Œï¼Œä¿æŒæ ‡å‡†è¾“å…¥æ‰“å¼€
            # --user root ï¼šä»¥rootç”¨æˆ·èº«ä»½åœ¨å®¹å™¨å†…è¿è¡Œå‘½ä»¤ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæƒé™
            # -v ï¼šå·æŒ‚è½½
            # -e ï¼šç¯å¢ƒå˜é‡ä¼ é€’
            docker run --rm -i \
              --user root \
              -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
              -v "${{ github.workspace }}/files:/home/build/immortalwrt/files" \
              -v "${{ github.workspace }}/src:/home/build/immortalwrt/src" \
              --env-file env.list \
              -e PART_SIZE="${firmware_size}" \
              "${IMAGE_NAME}" \
              /bin/bash /home/build/immortalwrt/src/build.sh
          done

      - name: ç”Ÿæˆå›ºä»¶SHA-256æ ¡éªŒå’Œ
        run: |
          # æ˜¾ç¤ºbinç›®å½•å†…å®¹ï¼Œç”¨äºè°ƒè¯•
          echo "binç›®å½•å†…å®¹:"
          find ${{ github.workspace }}/bin -name "*.zip" | sort
          
          # å¤åˆ¶åŠ å¯†zipåŒ…åˆ°å·¥ä½œç›®å½•ï¼ˆç›´æ¥ä»binç›®å½•ï¼‰
          cp ${{ github.workspace }}/bin/*.zip ${{ github.workspace }}/ || true
          # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
          cp ${{ github.workspace }}/bin/config_old.txt ${{ github.workspace }}/
          cp ${{ github.workspace }}/bin/config_new.txt ${{ github.workspace }}/
          # å¤åˆ¶åŒ…ä¿¡æ¯æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
          cp ${{ github.workspace }}/bin/packages_info.txt ${{ github.workspace }}/ || true
          
          # æ˜¾ç¤ºå½“å‰ç›®å½•å†…å®¹ï¼Œç”¨äºè°ƒè¯•
          echo "å½“å‰å·¥ä½œç›®å½•å†…å®¹:"
          ls -la ${{ github.workspace }}
          
          # ä¸ºæ‰€æœ‰zipåŒ…ç”ŸæˆSHA-256æ ¡éªŒå’Œ
          for file in *.zip; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256"
              sha256sum -c "$file.sha256"
            fi
          done
          
          # è¯»å–åŒ…ä¿¡æ¯æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "${{ github.workspace }}/packages_info.txt" ]; then
            source "${{ github.workspace }}/packages_info.txt"
            echo "BASE_PACKAGES=$BASE_PACKAGES" >> $GITHUB_ENV
            echo "EXTRA_PACKAGES=$EXTRA_PACKAGES" >> $GITHUB_ENV
            echo "CUSTOM_PACKAGES=$CUSTOM_PACKAGES" >> $GITHUB_ENV
            echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV
          fi

      # åˆ é™¤å·²å­˜åœ¨çš„æ ‡ç­¾
      - name: åˆ é™¤å·²ç»å­˜åœ¨çš„æ ‡ç­¾
        run: |
          git push --delete origin build-immortalwrt-${{ github.event.inputs.platform_type }}-${{ github.event.inputs.firmware_version }} || true
        continue-on-error: true
        
      # æ¸…ç†ä¹‹å‰å‘å¸ƒçš„èµ„äº§æ–‡ä»¶
      - name: æ¸…ç†ä¹‹å‰çš„å‘å¸ƒèµ„äº§
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          tag_name: ImmortalWrt-${{ github.event.inputs.platform_type }}-${{ github.event.inputs.firmware_version }}
          delete_release: true
          repo: ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¿®æ”¹å‘å¸ƒæ­¥éª¤ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„å›ºä»¶ä¿¡æ¯
      - name: å°†æ„å»ºçš„å›ºä»¶ä½œä¸ºReleaseå‘å¸ƒ
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: ImmortalWrt-${{ github.event.inputs.platform_type }}-${{ github.event.inputs.firmware_version }}
          body: |
            ### ImmortalWrt å›ºä»¶ä¿¡æ¯
            - å¹³å°: ${{ github.event.inputs.platform_type }}
            - ç‰ˆæœ¬: ${{ github.event.inputs.firmware_version }}
            - å›ºä»¶å¤§å°: ${{ github.event.inputs.firmware_size }} MB
            
            ### é…ç½®æ–‡ä»¶
            - config_old.txt - åŸå§‹é…ç½®æ–‡ä»¶
            - config_new.txt - ä¿®æ”¹åé…ç½®æ–‡ä»¶
            
            ### è½¯ä»¶åŒ…ä¿¡æ¯
            #### åŸºç¡€è½¯ä»¶åŒ…
            ```
            ${{ env.BASE_PACKAGES }}
            ```
            
            #### é¢å¤–è½¯ä»¶åŒ…
            ```
            ${{ env.EXTRA_PACKAGES }}
            ```
            
            #### è‡ªå®šä¹‰è½¯ä»¶åŒ…
            ```
            ${{ env.CUSTOM_PACKAGES }}
            ```
            
            #### éœ€è¦å®‰è£…çš„è½¯ä»¶åŒ…
            ```
            ${{ env.PACKAGES }}
            ```
            
            ### åŠ å¯†å›ºä»¶åŒ…
            - åŠ å¯†æ–¹å¼: ZIPåŠ å¯†
            - å¯†ç : è¯·è”ç³»ç®¡ç†å‘˜è·å–
            
            ### å›ºä»¶SHA256æ ¡éªŒå’Œ
            è¯·æŸ¥çœ‹é™„ä»¶ä¸­çš„ .sha256 æ–‡ä»¶
          files: |
            ${{ github.workspace }}/*.zip
            ${{ github.workspace }}/*.sha256
            ${{ github.workspace }}/config_old.txt
            ${{ github.workspace }}/config_new.txt
            ${{ github.workspace }}/packages_info.txt
          token: ${{ secrets.GITHUB_TOKEN }}
          generate_release_notes: false
          draft: false
          prerelease: false
          make_latest: true